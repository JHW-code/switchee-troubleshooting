<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üì± Mobile Issues Troubleshooting Builder</title>

  <!-- PWA manifest & theme color -->
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#0056b3">

  <!-- Global stylesheet -->
  <link href="../global.css" rel="stylesheet">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    /* Styles omitted for brevity ‚Äî use your existing CSS */
  </style>
</head>
<body>

  <!-- LEAF HEADER -->
  <header class="site-header">
    <img src="../leaf.png" class="site-logo" alt="Leaf Logo">
    <h1 class="site-title">üì± Mobile Issues Troubleshooting Builder</h1>
  </header>

  <div class="back-menu">
    <a href="index.html">&larr; Back to Mobile Menu</a>
  </div>

  <div class="container">
    <h1>Builder</h1>

    <section>
      <h2>Create or Edit Mobile Situation</h2>
      <label for="editSelect">Select Situation to Edit (or leave blank to create new):</label>
      <select id="editSelect">
        <option value="">-- New Situation --</option>
      </select>

      <label for="title">Situation Title:</label>
      <input id="title" placeholder="E.g., Situation M2: Bluetooth pairing">

      <div id="steps"></div>

      <button id="previewBtn">Preview Situation</button>
      <button id="downloadBtn" style="display:none;">Download Situation Page</button>

      <div id="linkContainer" style="display:none;">
        <label for="linkSnippet">Copy this link into mobile/index.html:</label>
        <textarea id="linkSnippet" readonly></textarea>
      </div>

      <iframe id="previewFrame"></iframe>
    </section>

    <section>
      <h2>Delete Mobile Situation</h2>
      <label for="deleteSelect">Select Situation to Delete:</label>
      <select id="deleteSelect">
        <option value="">-- Choose --</option>
      </select>
      <button id="deleteBtn">Generate Delete Instructions</button>
      <pre id="deleteInstructions" style="margin-top:20px;"></pre>
    </section>
  </div>

  <footer class="footer-menu">
    <a href="builder.html">üõ†Ô∏è Manage Mobile Situations</a>
    <a href="../index.html">Gen2</a>
    <a href="../history.html">üìú History</a>
    <a href="../econa/index.html">‚öôÔ∏è Econa</a>
  </footer>

  <!-- All builder logic goes inside this single <script> -->
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    // Utility to load mobile/index.html menu links
    async function loadPages() {
      const resp = await fetch('index.html');
      const doc = new DOMParser().parseFromString(await resp.text(), 'text/html');
      const pages = {};
      doc.querySelectorAll('.menu a').forEach(a => {
        pages[a.getAttribute('href')] = a.textContent.trim();
      });
      return pages;
    }

    const pages = await loadPages();

    // Populate edit/delete selects
    const editSelect = document.getElementById('editSelect');
    const deleteSelect = document.getElementById('deleteSelect');
    for (const [file,label] of Object.entries(pages)) {
      editSelect.insertAdjacentHTML('beforeend',
        `<option value="${file}">${label}</option>`);
      deleteSelect.insertAdjacentHTML('beforeend',
        `<option value="${file}">${label}</option>`);
    }

    // Inject step/detail/image inputs
    const stepsDiv = document.getElementById('steps');
    for (let i = 1; i <= 5; i++) {
      stepsDiv.insertAdjacentHTML('beforeend', `
        <label for="step${i}">Step ${i}:</label>
        <input id="step${i}" placeholder="Step ${i} description...">
        <label for="detail${i}">Detail ${i}:</label>
        <textarea id="detail${i}" rows="2" placeholder="Detail for step ${i}..."></textarea>
        <label for="img${i}">Image for Step ${i} (optional):</label>
        <input type="file" id="img${i}" accept="image/*">
      `);
    }

    // Prefill on edit
    editSelect.onchange = async () => {
      const f = editSelect.value;
      if (!f) {
        document.getElementById('title').value = '';
        for (let i=1; i<=5; i++) {
          document.getElementById(`step${i}`).value = '';
          document.getElementById(`detail${i}`).value = '';
          document.getElementById(`img${i}`).value = '';
        }
        return;
      }
      const resp = await fetch(f);
      const doc  = new DOMParser().parseFromString(await resp.text(),'text/html');
      document.getElementById('title').value = doc.querySelector('h1').textContent.trim();
      for (let i=1; i<=5; i++) {
        const stepEl   = doc.querySelector(`.flow a[href="#section${i}"]`);
        const detailEl = doc.querySelector(`#section${i} p`);
        document.getElementById(`step${i}`).value   = stepEl   ? stepEl.textContent.trim() : '';
        document.getElementById(`detail${i}`).value = detailEl ? detailEl.textContent.trim() : '';
        document.getElementById(`img${i}`).value    = '';
      }
    };

    // Build HTML function
    async function buildHTML() {
      const title = document.getElementById('title').value || 'New Situation';
      let html = `<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><title>${title}</title>
<link href="../global.css" rel="stylesheet">
<link rel="manifest" href="../manifest.json">
<meta name="theme-color" content="#0056b3">
<style>
  /* Paste your common_css here */
</style></head><body>
<header class="site-header">
  <img src="../leaf.png" class="site-logo" alt="Leaf Logo">
  <h1 class="site-title">${title}</h1>
</header>
<div class="back-menu"><a href="index.html">&larr; Back to Mobile Menu</a></div>
<div class="flow">`;

      // Steps links
      for (let i=1; i<=5; i++){
        const txt = document.getElementById(`step${i}`).value || `Step ${i}`;
        html += `<a href="#section${i}">${txt}</a>`;
      }
      html += `</div>`;

      // Details & optional images
      for (let i=1; i<=5; i++){
        const detail = document.getElementById(`detail${i}`).value || '';
        html += `<section id="section${i}"><h2>Step ${i}</h2><p>${detail}</p>`;
        const fileInput = document.getElementById(`img${i}`);
        if (fileInput.files.length) {
          const dataURL = await new Promise(res => {
            const reader = new FileReader();
            reader.onload = e => res(e.target.result);
            reader.readAsDataURL(fileInput.files[0]);
          });
          html += `<img src="${dataURL}" class="step-image" alt="Step ${i} image">`;
        }
        html += `</section>`;
      }

      html += `<footer class="footer-menu">
  <a href="builder.html">üõ†Ô∏è Manage Mobile Situations</a>
  <a href="../index.html">Gen2</a>
  <a href="../history.html">üìú History</a>
  <a href="../econa/index.html">‚öôÔ∏è Econa</a>
</footer>
<script>if('serviceWorker' in navigator)navigator.serviceWorker.register('/sw.js');</script>
</body></html>`;
      return html;
    }

    // Preview & Download handler
    document.getElementById('previewBtn').onclick = async () => {
      const content = await buildHTML();
      const blob    = new Blob([content], {type:'text/html'});
      const url     = URL.createObjectURL(blob);
      document.getElementById('previewFrame').src = url;
      const dl = document.getElementById('downloadBtn');
      dl.style.display = 'inline-block';
      dl.onclick = () => {
        const a = document.createElement('a');
        a.href = url;
        const fn = (document.getElementById('title').value||'new-situation')
                     .toLowerCase().replace(/\s+/g,'-') + '.html';
        a.download = fn;
        a.click();
        document.getElementById('linkSnippet').value = `<a href="${fn}">${document.getElementById('title').value}</a>`;
        document.getElementById('linkContainer').style.display = 'block';
      };
    };

    // Delete instructions handler
    document.getElementById('deleteBtn').onclick = () => {
      const f = deleteSelect.value;
      if (!f) {
        document.getElementById('deleteInstructions').textContent = 'Please select a situation to delete.';
        return;
      }
      document.getElementById('deleteInstructions').textContent =
        `1) Delete "${f}".\n2) Remove this line from mobile/index.html:\n` +
        `<li><a href="${f}">${pages[f]}</a></li>`;
    };
  });
  </script>

  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js');
    }
  </script>
</body>
</html>
